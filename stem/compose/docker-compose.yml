services:
  stem:
    build:
      context: ..
      dockerfile: image/Dockerfile
      args:
        TZ: ${TZ}
        APOGEE_VERSION: ${APOGEE_VERSION:-}

    image: hatch-stem:local
    container_name: ${STEM_CONTAINER_NAME}
    hostname: ${STEM_HOSTNAME}
    restart: unless-stopped

    ports:
      - "${STEM_SSH_PORT:-22222}:22"

    env_file:
      - .env

    environment:
      TZ: ${TZ}
      TERM: ${TERM}
      COLORTERM: ${COLORTERM}

      STEM_SSH_PASSWORD_AUTH: ${STEM_SSH_PASSWORD_AUTH}
      STEM_SSH_PASSWORD: ${STEM_SSH_PASSWORD}

      STEM_ALLOW_ROOT_LOGIN: ${STEM_ALLOW_ROOT_LOGIN:-0}

      BINDU_REPO: ${BINDU_REPO}
      BINDU_REF: ${BINDU_REF}

      STEM_USER: ${STEM_USER}
      STEM_UID: ${STEM_UID}
      STEM_GID: ${STEM_GID}

    volumes:
      - ${STEM_WORKSPACE}:/workspace

      # Persistent home
      - stem_home:/home

      # Persist host keys only (safe)
      - stem_ssh_host_keys:/etc/ssh/host_keys

      # Authorized keys from host
      - ${STEM_AUTH_KEYS_FILE}:/opt/ssh/authorized_keys:ro

    working_dir: /workspace
    tty: true
    stdin_open: true
    network_mode: bridge

volumes:
  stem_home:
  stem_ssh_host_keys:
