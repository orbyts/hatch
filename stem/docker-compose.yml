services:
  stem:
    build:
      context: .
      dockerfile: image/Dockerfile

    container_name: ${STEM_CONTAINER_NAME:-stem}
    hostname: ${STEM_HOSTNAME:-stem}

    env_file:
      - .env

    ports:
      - "${STEM_SSH_PORT:-22222}:22"

    environment:
      STEM_USER: "${STEM_USER:-dev}"
      STEM_UID: "${STEM_UID:-1000}"
      STEM_GID: "${STEM_GID:-1000}"
      STEM_PASSWORD: "${STEM_PASSWORD:-change-me}"

      BINDU_REPO: "${BINDU_REPO:-}"
      BINDU_REF: "${BINDU_REF:-main}"
      BINDU_FORCE: "${BINDU_FORCE:-0}"

    volumes:
      - home:/home/${STEM_USER:-dev}
      - sshkeys:/etc/ssh/keys
      - sshstate:/opt/stem/ssh
      - "${STEM_AUTH_KEYS_PATH}:/opt/ssh/authorized_keys:ro"

    restart: unless-stopped

volumes:
  home:
    external: true
  sshkeys:
    external: true
  sshstate:
    external: true
